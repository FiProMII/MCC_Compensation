@{ Layout = "_LayoutAdmin";
    ViewBag.Title = "New Request";
}

<!-- ============================================================== -->
<!-- Container fluid  -->
<!-- ============================================================== -->
<div class="container-fluid">
    <!-- ============================================================== -->
    <!-- Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <div class="row page-titles">
        <div class="col-md-6 col-8 align-self-center">
            <h3 class="text-themecolor m-b-0 m-t-0">@ViewData["Title"]</h3>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/Dashboard/Index">Home</a></li>
                <li class="breadcrumb-item active">@ViewData["Title"]</li>
            </ol>
        </div>
        <div class="col-md-6 col-4 align-self-center">
            <a href="/Request/Index" class="btn pull-right hidden-sm-down btn-outline-secondary"><i class="mdi mdi-keyboard-backspace"></i> Back</a>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Start Page Content -->
    <!-- ============================================================== -->
    <!-- Row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card card-outline-info">
                <div class="card-header">
                    <h4 class="m-b-0 text-white">@ViewData["Title"]</h4>
                </div>
                <div class="card-body">
                    <form class="form-horizontal" role="form" id="form">
                        <div class="form-body">
                            <h3 class="box-title m-t-40">New Request</h3>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Compensation Type</label>
                                        <select class="form-control custom-select" id="CompensationID" name="CompensationID"></select>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Event Date</label>
                                        <input type="date" class="form-control" id="EventDate" name="EventDate" onchange="ValidateDED()">
                                        <small class="text-danger" id="errorMessage"></small>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group" id="compensationDetail">
                                    </div>
                                </div>
                                <div class="col-md-6 bag">
                                    <div class='element' id='div_1'>
                                        <div class="form-group">
                                            <label>File Upload</label> 
                                            <div class="add btn btn-sm btn-outline-success pull-right">Add File</div>
                                            <div class="controls">
                                                <input type="file" name="file" class="custom-file form-control" id="txt_1" accept="image/jpg, image/jpeg, .pdf" required />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a type="button" class="btn btn-outline-dark waves-effect waves-light" href="/Request/Index">Cancel</a>
                            <button type="submit" class="btn btn-success waves-effect waves-light"><i class="fa fa-check"></i> Send Request</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Row -->
</div>

@section scripts
{
    <script>
        var compensationID

        let compensationValue = new Map()
        let compensationRequirement = new Map()

        $(document).ready(function () {

            compensationRequirement.set("Wedding", "KK & KTP")
            compensationRequirement.set("Baby Gift", "KK")
            compensationRequirement.set("Grief", "KK")

            var compensationDropdown = '<option value="-1">Please select a compensation type</option>';
            $.ajax({
                type: "GET",
                url: '/compensation/get',
                success: function (result) {
                    var data = result['result']
                    for (var i = 0; i < data.length; i++) {
                        var compensationDropdown = '<option value="-1">Please select a compensation type</option>'
                        compensationDropdown += '<option value="' + data[i].compensationID + '">' + data[i].compensationName + '</option>';
                        $("#CompensationID").html(compensationDropdown);
                        compensationValue.set(data[i].compensationName, data[i].cost)
                    }
                }
            });

            $(".add").click(function () {
                var total_element = $(".element").length;
                var lastid = $(".element:last").attr("id");
                var split_id = lastid.split("_");
                var nextindex = Number(split_id[1]) + 1;
                var max = 2;

                if (total_element < max) {
                    $(".element:last").after("<div class='element' id='div_" + nextindex + "'></div>");
                    $("#div_" + nextindex).append("<div class='form-group'><div id='remove_"
                        + nextindex + "' class='remove btn btn-sm btn-outline-danger pull-right'>Abort</div>"
                        + "<div class='controls'><input type='file' name='file' class='custom-file form-control' id='txt_" 
                        + nextindex + "' accept='image / jpg, image / jpeg, .pdf' required /></div>");
                }
            });

            $('.bag').on('click', '.remove', function () {
                var id = this.id;
                var split_id = id.split("_");
                var deleteindex = split_id[1];

                $("#div_" + deleteindex).remove();
            });
        });

        @*function ValidateDED() {
            var dateString = new Date($('#EventDate').val());
            var dateNow = new Date();
            if ($('#EventDate').val() == "") {
                $('#EventDate').focus();
                $('#messageError').html("The date is <code>Incorrect.</code>");
            } else if (dateNow.getFullYear() - dateString.getFullYear() == 0) {
                alert('Please set another Date');
                $('#EventDate').val('');
                $('#messageError').html("The date is <code>Incorrect.</code>");
            }
            $('#messageError').html("");
        }*@

        $("select#CompensationID").on('change', function () {
            var selectedCompensationText = $('#CompensationID option:selected').text();
            compensationID = parseInt($('#CompensationID option:selected').val());
            var compensationDetail = '<label class="col-md-4 col-form-label">Document Details</label>' +
                '<div class="col-md-7 col-form-label" >' +
                '<span>Requirement: ' + compensationRequirement.get(selectedCompensationText) + '</span><br />' +
                '<span>Value: ' + compensationValue.get(selectedCompensationText) + '</span></div>'
            $('#compensationDetail').html(compensationDetail)
        })

        $('#form').submit(function (event) {
            event.preventDefault()

            var formData = new FormData($(this)[0]);
            formData.append('nik', currentNIK);
            formData.append('compensationID', compensationID)
            formData.append('eventDate', $('#EventDate').val())
            $.ajax({
                url: '/Document/Post',
                type: 'POST',
                data: formData,
                async: false,
                cache: false,
                contentType: false,
                enctype: 'multipart/form-data',
                processData: false,
                success: function (response) {

                }
            });
        })

    </script>
}
