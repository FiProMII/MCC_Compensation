@{ Layout = "_LayoutAdmin";
    ViewData["Title"] = "Approval Request";
}

<!-- ============================================================== -->
<!-- Container fluid  -->
<!-- ============================================================== -->
<div class="container-fluid">
    <!-- ============================================================== -->
    <!-- Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <div class="row page-titles">
        <div class="col-md-6 col-8 align-self-center">
            <h3 class="text-themecolor m-b-0 m-t-0">@ViewData["Title"]</h3>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                <li class="breadcrumb-item active">@ViewData["Title"]</li>
            </ol>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Start Page Content -->
    <!-- ============================================================== -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card card-outline-info">
                <div class="card-header">
                    <h4 class="m-b-0 text-white">Approval Request</h4>
                </div>
                <div class="card-body">
                    <form class="form-horizontal" role="form" id="form">
                        <div class="form-body">
                            <h3 class="box-title">Person Info</h3>
                            <hr class="m-t-0 m-b-40">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Requester:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="Requester"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--/row-->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Department:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="DepartmentName"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Relation Manager:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="ManagerName"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <!--/row-->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Position:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="PositionName"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Join Date:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="JoinDate"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <!--/row-->
                            <h3 class="box-title">Compensation Request</h3>
                            <hr class="m-t-0 m-b-40">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Number:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="RequestID"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Event Date:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="EventDate"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Compensation Type:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="CompensationName"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <!--/row-->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Request Date:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="RequestDate"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="control-label text-right col-md-4">Document:</label>
                                        <div class="col-md-8">
                                            <p class="form-control-static" id="Document"></p>
                                        </div>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                        </div>
                        <div class="form-actions">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-offset-3 col-md-8" id="button">
                                            <button type="submit" value="Approve" class="btn btn-outline-success"> <i class="mdi mdi-checkbox-marked-circle-outline"></i> Approve</button>
                                            <button type="submit" value="Reject" class="btn btn-outline-danger"><i class="mdi mdi-alert-octagram"></i> Reject</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Row -->
    <!-- ============================================================== -->
    <!-- End PAge Content -->
    <!-- ============================================================== -->
</div>
<!-- ============================================================== -->
<!-- End Container fluid  -->
<!-- ============================================================== -->

<div id="modalRejected" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form class="form-horizontal" role="form" id="formReject">
                <div class="modal-body">
                    <div class="form-group controls" id="excuseText">
                        <label id="messageText"><strong>Please enter why you declined this request</strong></label>
                        <textarea class="form-control" rows="5" id="textArea" required></textarea>
                    </div>
                    <p>Do you want to save changes you made before closing?</p>
                    <p class="text-warning"><small>If you don't save, your changes will be lost.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChange">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts
{
    <script>
        var managerNIK;
        var requestID;
        $.urlParam = function (name) {
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            if (results == null) {
                return null;
            }
            return decodeURI(results[1]) || 0;
        }

        $(document).ready(function () {
            var id = $.urlParam('id')
            if (id != null) {
                $.ajax({
                    url: "/Request/GetById",
                    type: "GET",
                    data: { 'key': id },
                    headers: { 'Authorization': 'Bearer ' + localStorage.token },
                    success: function (result) {
                        var data = result["result"];
                        managerNIK = data.employee.manager.nik
                        requestID = data.requestID
                        $('#Requester').html(data.employee.employeeName)
                        $('#DepartmentName').html(data.employee.position.department.departmentName)
                        $('#PositionName').html(data.employee.position.positionName)
                        $('#ManagerName').html(data.employee.manager.employeeName)
                        $('#JoinDate').html(moment(data.employee.joinDate).format('DD-MM-YYYY'))
                        $('#RequestID').html(data.requestID)
                        $('#RequestIDText').html(data.requestID)
                        $('#CompensationName').html(data.compensation.compensationName)
                        $('#EventDate').html(moment(data.eventDate).format('DD-MM-YYYY'))
                        $('#RequestDate').html(moment(data.requestDate).format('DD-MM-YYYY'))

                        for (var i = 0; i < data.documents.length; i++) {
                            if (data.documents[i].link.match(/(.*?)\.(pdf|PDF)$/)) {
                                var documentList = '<a target="_blank" href="' + data.documents[i].link
                                    + '"><img src="/lib/src/images/pdf.png" width="30">' + data.documents[i].documentName + '</><br/>'
                            } else if (data.documents[i].link.match(/(.*?)\.(jpg|jpeg|JPG|JPEG)$/)) {
                                var documentList = '<a target="_blank" href="' + data.documents[i].link
                                    + '"><img src="/lib/src/images/images.png" width="30">' + data.documents[i].documentName + '</>'
                            }
                            $('#Document').append(documentList);
                        }
                    }
                })
            }
        });

        var statusName;
        $('.btn').on('click', function () {
            statusName = $(this).val()
        })

        $('#form').submit(function (event) {
            event.preventDefault()
            var requestID = parseInt(document.getElementById("RequestID").innerHTML);
            var UpdateStatusVM = new Object();
            UpdateStatusVM.statusName = statusName;
            UpdateStatusVM.requestID = requestID;

            if (statusName == "Reject") {
                $('#modalRejected').modal({
                    backdrop: 'static'
                })
                $('#textArea').prop('required', true);
                $('#saveChange').on('click',function (event) {
                    event.preventDefault()
                    UpdateStatusVM.note = $('#textArea').val();
                    $.ajax({
                        type: "POST",
                        url: "/Approval/UpdateStatus",
                        data: JSON.stringify(UpdateStatusVM),
                        headers: { 'Authorization': 'Bearer ' + localStorage.token },
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function () {
                            $('#modalRejected').modal('hide');
                            $('#textArea').empty();
                            Swal.fire({
                                title: '<strong>Thank You</strong>',
                                icon: 'info',
                                html:
                                    'you succeeded in <b>giving approval</b> ',
                                focusConfirm: false,
                                confirmButtonText:
                                    '<i class="fa fa-thumbs-up"></i> Great!',
                                confirmButtonAriaLabel: 'Thumbs up, great!',
                                allowOutsideClick: false,
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "@Url.Action("Index", "Account")";
                                }
                            })
                        }
                    })
                })
            } else {
                UpdateStatusVM.note = "Approved without a hitch";
                $.ajax({
                    type: "POST",
                    url: "/Approval/UpdateStatus",
                    data: JSON.stringify(UpdateStatusVM),
                    headers: { 'Authorization': 'Bearer ' + localStorage.token },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function () {
                        Swal.fire({
                            title: '<strong>Thank You</strong>',
                            icon: 'info',
                            html:
                                'you succeeded in <b>giving approval</b> ',
                            focusConfirm: false,
                            confirmButtonText:
                                '<i class="fa fa-thumbs-up"></i> Great!',
                            confirmButtonAriaLabel: 'Thumbs up, great!',
                            allowOutsideClick: false,
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = "@Url.Action("Index", "Account")";
                            }
                        })
                    }
                })
            }
        })
    </script>
}
